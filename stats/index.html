<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock List (Responsive, Clean)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./tailwind-output.9f191f80.css" />

  <style>
    :root{
      --row-h: 44px;          /* desktop row height */
      --border:#E6E6E7; --border-soft:#F0F1F3; --focus:#2563eb33;

      --pos:#1A7F37; --neg:#B42318; --neu:#6E6E73;

      /* column minimums so content never smushes */
      --min-name: 10px;
      --min-price: 70px;
      --min-currency: 60px;
      --min-owners: 80px;
      --min-ret:  110px;

      /* growth ratios (desktop) */
      --name-fr: 1.8fr; --price-fr: .8fr; --currency-fr: .6fr; --owners-fr: .9fr; --ret-fr: .8fr;

      /* grid: NAME + PRICE + CURRENCY + OWNERS + 10 return columns (symbol removed) */
      --grid-template-full:
        minmax(var(--min-name), var(--name-fr))
        minmax(var(--min-price), var(--price-fr))
        minmax(var(--min-currency), var(--currency-fr))
        minmax(var(--min-owners), var(--owners-fr))
        repeat(10, minmax(var(--min-ret), var(--ret-fr)));

      /* default (price + currency hidden) */
      --grid-template-compact:
        minmax(var(--min-name), var(--name-fr))
        repeat(10, minmax(var(--min-ret), var(--ret-fr)));

      --grid-template: var(--grid-template-compact);

      /* dynamic width to keep body rows aligned with header on horizontal scroll */
      --grid-width: 1200px; /* JS updates this to header scrollWidth */
    }

    html, body{
      height:100%;
      margin:0;
      overflow:hidden; /* single scroll inside the card only */
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:#f5f6f8;
      color:#0B0B0C;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    .app{
      height:100vh; width:100%;
      display:flex; align-items:stretch; justify-content:center;
    }

    .card{
      width:100%; height:100%; max-width:1800px; margin:0;
      border:1px solid var(--border); border-radius:12px; background:#fff;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      display:flex; flex-direction:column;
    }

    .controls{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:12px; border-bottom:1px solid var(--border);
    }

    .pill-btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      width:38px;
      height:38px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background-color 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
      color:#2563EB;
      box-shadow:0 1px 2px rgba(15,23,42,0.04);
    }

    .pill-btn:hover,
    .pill-btn:focus{
      background:#EFF6FF;
      border-color:#BFDBFE;
      box-shadow:0 2px 6px rgba(37,99,235,0.15);
      outline:none;
    }

    .pill-btn svg{
      width:18px;
      height:18px;
      fill:none;
      stroke:currentColor;
      stroke-width:1.8;
      stroke-linecap:round;
      stroke-linejoin:round;
    }

    .sr-only {
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      border:0;
    }

    /* HORIZONTALLY SCROLLABLE AREA (single horizontal scrollbar here) */
    .table-wrap{
      flex:1; width:100%; position:relative;
      overflow-x:auto;   /* horizontal scroll lives here */
      overflow-y:hidden; /* vertical scroll is inside .viewport */
      -webkit-overflow-scrolling: touch;
    }

    /* sticky header aligned with body horizontally */
    .header-grid{
      position:sticky; top:0; z-index:3;
      background:#fff; border-bottom:1px solid var(--border);
      display:grid; grid-template-columns: var(--grid-template);
      padding:6px 12px;
      min-width:max-content; /* grow beyond container; wrapper provides scroll */
    }

    body.show-price-currency{
      --grid-template: var(--grid-template-full);
    }

    body:not(.show-price-currency) .col-price,
    body:not(.show-price-currency) .col-currency,
    body:not(.show-price-currency) .col-owners{
      display:none;
    }
    .cell{
      display:flex; align-items:center; gap:8px;
      font-weight:500; font-size:13px; color:#6E6E73;
      white-space:nowrap;
    }
    .sortable{ cursor:pointer; display:inline-flex; gap:6px; align-items:center }
    .sort-mark{ font-size:11px; opacity:.5 }
    .right{ justify-content:flex-end; text-align:right }
    .center{ justify-content:center; text-align:center }

    /* + / - / * filter input (numeric/tel keyboard) */
    .rule{
      width:40px; text-align:center;
      border:1px solid var(--border); border-radius:6px;
      padding:3px 5px; font-size:12px; font-weight:600;
      color:#6E6E73; background:#fafafa;
    }

    .filter{
      width:80px; text-align:left;
      font-weight:500;
    }
    .filter-currency{
      width:70px;
      text-transform:uppercase;
    }
    .filter-owners{
      width:90px;
    }
    .filter-name{
      width:180px;
      max-width:100%;
    }

    /* Vertical scrolling lives here; no horizontal scroll here */
    .viewport{
      position:relative;
      height:calc(100% - 44px); /* ≈ header height; keeps a single vertical scrollbar */
      overflow-y:auto;          /* vertical scroll */
      overflow-x:hidden;        /* prevent second horizontal scrollbar */
      min-width:max-content;    /* match header width so columns align */
    }
    .spacer{ height:0; width:var(--grid-width); }

    /* Whole row is a link if URL exists */
    .row{
      position:absolute; left:0; height:var(--row-h);
      width: var(--grid-width); /* keeps rows as wide as header */
      display:grid; grid-template-columns: var(--grid-template);
      border-bottom:1px solid var(--border-soft);
      align-items:center; padding:0 12px;
      background:#fff; color:inherit; text-decoration:none;
      transition: background-color 0.18s ease, box-shadow 0.18s ease;
    }
    .row:hover{ background:#f6f7f8 }
    .row.row-visited:not(.row-active){
      background-image: linear-gradient(90deg, rgba(37,99,235,0.06), rgba(37,99,235,0.01));
    }
    .row::before{
      content:'';
      position:absolute;
      left:6px;
      top:50%;
      width:8px;
      height:8px;
      border-radius:999px;
      background:transparent;
      opacity:0;
      transform:translateY(-50%) scale(0.7);
      transition: background-color 0.18s ease, opacity 0.18s ease, transform 0.18s ease;
    }
    .row.row-visited::before{
      opacity:1;
      background:rgba(37,99,235,0.35);
      transform:translateY(-50%) scale(1);
    }
    .row.row-active{
      background:#eef2ff;
      box-shadow: inset 0 0 0 1px rgba(37,99,235,0.35);
    }
    .row.row-active::before{
      opacity:1;
      background:rgba(37,99,235,0.95);
      transform:translateY(-50%) scale(1.1);
    }

    /* Name: desktop = single line; small screens = up to 2 lines (clamped) */
    .name{
      font-weight:600; font-size:14px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap; /* desktop default */
      max-width:100%;
    }

    .val{
      display:inline-block; font-weight:500; font-size:13px;
      font-variant-numeric:tabular-nums; white-space:nowrap;
    }
    .pos-text{ color:var(--pos); }
    .neg-text{ color:var(--neg); }
    .neu-text{ color:var(--neu); }

    .spark-wrap{
      display:flex; flex-direction:column; align-items:flex-end;
      gap:4px; min-width:110px;
    }
    .spark-wrap.spark-pos{ color:var(--pos); }
    .spark-wrap.spark-neg{ color:var(--neg); }
    .spark-wrap.spark-neu{ color:var(--neu); }
    .spark{
      width:110px; height:36px;
    }
    .spark svg{
      display:block; width:100%; height:100%; pointer-events:none;
    }
    .spark-area{ stroke:none; }
    .spark-line{ fill:none; stroke:currentColor; stroke-width:1.6; }
    .spark-zero{ stroke:rgba(11,11,12,0.18); stroke-width:0.6; }
    .spark-empty{
      border-radius:6px;
      background-image:linear-gradient(135deg, rgba(11,11,12,0.05) 25%, transparent 25%, transparent 50%, rgba(11,11,12,0.05) 50%, rgba(11,11,12,0.05) 75%, transparent 75%, transparent);
      background-size:6px 6px;
      border:1px dashed rgba(11,11,12,0.1);
    }

    /* ---------- Small screens ---------- */
    @media (max-width: 768px){
      :root{
        --row-h: 56px;  /* taller to allow up to 2 lines for name */
        --min-name: 10px;
        --min-ret: 90px;
      }
      .controls{ padding:10px }
      .header-grid{ padding:6px 10px }
      .row{ padding:0 10px }

      /* Stack filter box ABOVE label text */
      .cell{ flex-direction:column; align-items:flex-end; gap:4px; }
      .cell > .sortable{ order:2; }
      .cell > .rule{ order:1; }

      .cell.left .filter-name{
        width:100%;
      }

      /* Name: allow wrapping up to 2 lines */
      .name{
        white-space:normal;                /* allow wrap */
        display:-webkit-box;               /* clamp to two lines */
        -webkit-box-orient:vertical;
        -webkit-line-clamp:2;
        line-height:1.2;
        font-size:13px;
      }

      .spark-wrap{ min-width:90px; }
      .spark{ width:90px; }

      .val, .cell{ font-size:12.5px }
    }

      @media (max-width: 480px){
        :root{
          --row-h: 32px;  /* a bit taller on very small screens */
          --min-name: 10px;
          --min-ret: 90px;
        }
        .pill-btn{
          width:34px;
          height:34px;
        }

        .spark-wrap{ min-width:84px; }
        .spark{ width:84px; }
      }
	
	/* Force left align for the Name header cell */
	.cell.left{
	  align-items: flex-start;
	  text-align: left;
	}

	/* On small screens we flip header cells to column + right; keep Name left */
	@media (max-width: 768px){
	  .cell.left{
		align-items: flex-start !important; /* override the mobile .cell rule */
		text-align: left !important;
	  }
	}

	html, body {
	  font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
	}
	
/* Hide "Get Latest" on mobile screens */
@media (max-width: 768px) {
  .desktop-only {
    display: none !important;
  }
}

  </style>
</head>
<script>
// Auto-redirect if opened via file://
if (location.protocol === 'file:') {
  const target = 'http://127.0.0.1:8000/index.html';
  console.log('Opening via file:// is not supported. Redirecting to', target);
  location.href = target;
}
</script>

  <div class="app">
    <div class="card">
	  <!-- top controls -->
          <div id="controls" class="controls">
                  <span id="countBadge" class="meta text-sm text-neutral-500"></span>

                  <div class="actions ml-auto flex gap-2">
                    <button id="resetBtn" class="pill-btn" aria-label="Reset filters">
                      <span class="sr-only">Reset filters</span>
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M4 4v6h6" />
                        <path d="M20 20v-6h-6" />
                        <path d="M5.64 18.36A9 9 0 1 1 18 6" />
                      </svg>
                    </button>
                    <button id="togglePriceCurrencyBtn" class="pill-btn" aria-pressed="false" aria-label="Toggle price, currency, and owners columns">
                      <span class="sr-only">Toggle price, currency, and owners columns</span>
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M1.5 12s3.5-6 10.5-6 10.5 6 10.5 6-3.5 6-10.5 6-10.5-6-10.5-6Z" />
                        <circle cx="12" cy="12" r="3" />
                      </svg>
                    </button>
                    <button id="refreshBtn" class="pill-btn" aria-label="Refresh data">
                      <span class="sr-only">Refresh data</span>
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M21 3v6h-6" />
                        <path d="M3 21v-6h6" />
                        <path d="M20 9a9 9 0 0 0-15.36-4.36M4 15a9 9 0 0 0 15.36 4.36" />
                      </svg>
                    </button>
                          <button id="getLatestBtn" class="pill-btn desktop-only" aria-label="Get latest snapshot">
                            <span class="sr-only">Get latest snapshot</span>
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                              <path d="M12 4v12" />
                              <path d="M6 10l6 6 6-6" />
                              <path d="M5 20h14" />
                            </svg>
                          </button>
                          <button id="newSharesBtn" class="pill-btn" aria-label="New share issues">
                            <span class="sr-only">New share issues</span>
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                              <path d="M12 5v14" />
                              <path d="M5 12h14" />
                            </svg>
                          </button>
			</div>
		</div>


      <!-- one horizontal scrollbar (here) -->
      <div class="table-wrap" id="tableWrap">
        <!-- header -->
        <div id="headerGrid" class="header-grid">
          <div class="cell left">
            <input id="filter-name" class="rule filter filter-name" placeholder="Filter" />
            <span class="sortable" data-sort="name">Name <span id="sort-name" class="sort-mark"></span></span>
          </div>

          <div class="cell right col-price">
            <input id="filter-price" class="rule filter" placeholder="Filter" inputmode="decimal" />
            <span class="sortable" data-sort="price">Price <span id="sort-price" class="sort-mark"></span></span>
          </div>
          <div class="cell center col-currency">
            <input id="filter-currency" class="rule filter filter-currency" placeholder="Filter" maxlength="6" />
            <span class="sortable" data-sort="currency">Currency <span id="sort-currency" class="sort-mark"></span></span>
          </div>
          <div class="cell right col-owners">
            <input id="filter-owners" class="rule filter filter-owners" placeholder="Filter" inputmode="decimal" value="100" />
            <span class="sortable" data-sort="number_of_owners">Owners <span id="sort-number_of_owners" class="sort-mark"></span></span>
          </div>


          <!-- numeric/tel keyboard; only + - * allowed. On small screens the input stacks ABOVE the label. -->
          <div class="cell right">
            <input id="rule-yield_1d"  class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\\-*]" />
            <span class="sortable" data-sort="yield_1d">1D<span id="sort-yield_1d" class="sort-mark"></span></span>
          </div>
          <div class="cell right">
            <input id="rule-yield_1w"  class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\\-*]" />
            <span class="sortable" data-sort="yield_1w">1W<span id="sort-yield_1w" class="sort-mark"></span></span>
          </div>
          <div class="cell right">
            <input id="rule-yield_1m"  class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\\-*]" />
            <span class="sortable" data-sort="yield_1m">1M<span id="sort-yield_1m" class="sort-mark"></span></span>
          </div>
          <div class="cell right">
            <input id="rule-yield_3m"  class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\\-*]" />
            <span class="sortable" data-sort="yield_3m">3M<span id="sort-yield_3m" class="sort-mark"></span></span>
          </div>
          <div class="cell right">
            <input id="rule-yield_ytd" class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\\-*]" />
            <span class="sortable" data-sort="yield_ytd">YTD<span id="sort-yield_ytd" class="sort-mark"></span></span>
          </div>
          <div class="cell right">
            <input id="rule-yield_1y"  class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\\-*]" />
            <span class="sortable" data-sort="yield_1y">1Y<span id="sort-yield_1y" class="sort-mark"></span></span>
          </div>
          <div class="cell right">
            <input id="rule-yield_3y"  class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\\-*]" />
            <span class="sortable" data-sort="yield_3y">3Y<span id="sort-yield_3y" class="sort-mark"></span></span>
          </div>
          <div class="cell right">
            <input id="rule-yield_5y"  class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\\-*]" />
            <span class="sortable" data-sort="yield_5y">5Y<span id="sort-yield_5y" class="sort-mark"></span></span>
          </div>
			<div class="cell right">
			  <input id="rule-yield_10y" class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\-*]" />
			  <span class="sortable" data-sort="yield_10y">10Y <span id="sort-yield_10y" class="sort-mark"></span></span>
			</div>

			<!-- Last column = Max (all-time) -->
			<div class="cell right">
			  <input id="rule-yield_max" class="rule" placeholder="+/-/*" maxlength="1" inputmode="tel" pattern="[+\-*]" />
			  <span class="sortable" data-sort="yield_max">Max <span id="sort-yield_max" class="sort-mark"></span></span>
			</div>

        </div>

        <!-- vertical scroll lives here -->
        <div id="viewport" class="viewport">
          <div id="spacer" class="spacer"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let DATA_URL = './nordnet_stocklist_merged_full.json';
// Attempt to discover the latest JSON in ./data/ by parsing the directory listing (python http.server)
const LIST_DIR = './data/';
const FILE_REGEX = /^stocklist_page-\d+_(\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}Z)\.json$/;

async function resolveLatestDataUrl(){
  try{
    // Fetch directory listing from ./data/ (works when no index.html exists in that folder)
    const res = await fetch(LIST_DIR);
    const html = await res.text();
    const doc  = new DOMParser().parseFromString(html, 'text/html');
    const links = Array.from(doc.querySelectorAll('a')).map(a => decodeURIComponent(a.getAttribute('href')||''));
    const candidates = links.filter(name => FILE_REGEX.test(name));
    if(!candidates.length) return DATA_URL; // no matching files, keep default
    const latest = candidates
      .map(name => ({
        name,
        // Convert 2025-10-20T10-36-55Z -> valid ISO 2025-10-20T10:36:55Z
        date: new Date(FILE_REGEX.exec(name)[1].replace(/T(\d{2})-(\d{2})-(\d{2})Z/, 'T$1:$2:$3Z'))
      }))
      .sort((a,b)=> b.date - a.date)[0];
    return LIST_DIR + latest.name;
  }catch(err){
    console.warn('Could not resolve latest JSON from ./data/. Falling back to default.', err);
    return DATA_URL;
  }
}

// --- New Shares helpers ---
async function listStockFilesSorted(){
  try{
    const res = await fetch(LIST_DIR);
    const html = await res.text();
    const doc  = new DOMParser().parseFromString(html, 'text/html');
    const links = Array.from(doc.querySelectorAll('a')).map(a => decodeURIComponent(a.getAttribute('href')||''));
    const candidates = links.filter(name => FILE_REGEX.test(name)).map(name => {
      const iso = FILE_REGEX.exec(name)[1].replace(/T(\d{2})-(\d{2})-(\d{2})Z/, 'T$1:$2:$3Z');
      return { name, iso, date: new Date(iso) };
    }).sort((a,b)=> b.date - a.date);
    return candidates;
  }catch(e){
    console.warn('Could not list ./data directory.', e);
    return [];
  }
}

function keyOf(r){
  return r.isin || r.symbol || (r.name ? r.name + '|' + (r.country||'') : '');
}

async function loadNormalized(url){
  const res = await fetch(url);
  const json = await res.json();
  const results = Array.isArray(json?.results) ? json.results : Array.isArray(json) ? json : [];
  return results.map(r=>{
    const ii=r.instrument_info||{};
    const hr=r.historical_returns_info||{};
    const ex=r.exchange_info||{};
    const nnx=r.nnx_info||{};
    const si=r.statistical_info||{};
    const pi=r.price_info||{};
    const resolved=resolveDisplayPrice(pi);
    const normalized={
      name:ii.long_name||ii.name||'',
      symbol:ii.symbol||'',
      isin:ii.isin||'',
      country:ex.exchange_country||'',
      display_slug:nnx.display_slug||'',
      price:nval(resolved.price),
      price_decimals:resolved.decimals,
      currency:ii.currency||ii.price_unit||'',
      number_of_owners:nval(si.number_of_owners),
      yield_1d:nval(hr.yield_1d),
      yield_1w:nval(hr.yield_1w),
      yield_1m:nval(hr.yield_1m),
      yield_3m:nval(hr.yield_3m),
      yield_ytd:nval(hr.yield_ytd),
      yield_1y:nval(hr.yield_1y),
      yield_3y:nval(hr.yield_3y),
      yield_5y:nval(hr.yield_5y),
      yield_10y:nval(hr.yield_10y),
      yield_max:nval(hr.yield_max)
    };
    normalized._key = keyOf(normalized);
    return normalized;
  });
}

async function showNewShares(){
  // Discover latest two files
  const files = await listStockFilesSorted();
  if(files.length < 2){
    alert('Not enough snapshots in ./data to compare. Need at least two.');
    return;
  }
  const latest = LIST_DIR + files[0].name;
  const prev   = LIST_DIR + files[1].name;

  // Load both
  const [a, b] = await Promise.all([loadNormalized(latest), loadNormalized(prev)]);
  const prevKeys = new Set(b.map(keyOf));
  const newestOnly = a.filter(item => !prevKeys.has(keyOf(item)));

  // If none, inform and still show empty state
  all = newestOnly;
  base = all;
  sortKey='yield_ytd'; sortDir='desc'; // default sort for clarity
  pendingScrollTop=0;
  apply();

  // Update badge with a friendly message
  const added = newestOnly.length;
  const msg = added === 1 ? '1 new since last snapshot' : (added + ' new since last snapshot');
  if (typeof countEl !== 'undefined' && countEl) {
    countEl.textContent = msg;
  }
}



    const BUFFER = 8;
    const MAX_ROWS = 120;
    const DEBOUNCE = 200;
    const DEBOUNCE_RULE = 200;

    const nval = n => Number.isFinite(n) ? n : null;

    const RETURN_FIELDS = ['yield_1d','yield_1w','yield_1m','yield_3m','yield_ytd','yield_1y','yield_3y','yield_5y','yield_10y','yield_max'];

    function returnClass(n){
      if(n==null) return 'neu-text';
      return n>0 ? 'pos-text' : 'neg-text';
    }

    function formatReturn(n){
      if(n==null) return '—';
      const v=Math.round(Math.abs(n));
      return v.toLocaleString('en-US');
    }

    function hashSeed(str){
      let h=1779033703 ^ str.length;
      for(let i=0;i<str.length;i++){
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      h = Math.imul(h ^ (h >>> 16), 2246822507) ^ Math.imul(h ^ (h >>> 13), 3266489909);
      return (h ^ (h >>> 16)) >>> 0;
    }

    const SPARK_DEPENDENCIES = {
      yield_1d: ['yield_1d'],
      yield_1w: ['yield_1d', 'yield_1w'],
      yield_1m: ['yield_1d', 'yield_1w', 'yield_1m'],
      yield_3m: ['yield_1d', 'yield_1w', 'yield_1m', 'yield_3m'],
      yield_ytd: ['yield_1d', 'yield_1w', 'yield_1m', 'yield_3m', 'yield_ytd'],
      yield_1y: ['yield_1d', 'yield_1w', 'yield_1m', 'yield_3m', 'yield_ytd', 'yield_1y'],
      yield_3y: ['yield_1d', 'yield_1w', 'yield_1m', 'yield_3m', 'yield_ytd', 'yield_1y', 'yield_3y'],
      yield_5y: ['yield_1d', 'yield_1w', 'yield_1m', 'yield_3m', 'yield_ytd', 'yield_1y', 'yield_3y', 'yield_5y'],
      yield_10y: ['yield_1d', 'yield_1w', 'yield_1m', 'yield_3m', 'yield_ytd', 'yield_1y', 'yield_3y', 'yield_5y', 'yield_10y'],
      yield_max: ['yield_1d', 'yield_1w', 'yield_1m', 'yield_3m', 'yield_ytd', 'yield_1y', 'yield_3y', 'yield_5y', 'yield_10y', 'yield_max'],
    };

    function sparkSeriesForField(row, field){
      const dependencies = SPARK_DEPENDENCIES[field] || [field];
      const series = [0];
      dependencies.forEach(key => {
        const value = row[key];
        if(Number.isFinite(value)){
          if(series[series.length-1] !== value){
            series.push(value);
          }
        }
      });
      if(series.length < 2){
        return null;
      }
      if(series[series.length-1] !== row[field] && Number.isFinite(row[field])){
        series.push(row[field]);
      }
      return series.length > 1 ? series : null;
    }

    function buildSparkSvg(points, gradientId){
      if(!points || !points.length) return '';
      const width = 110;
      const height = 36;
      let min = Math.min(...points, 0);
      let max = Math.max(...points, 0);
      if(!Number.isFinite(min) || !Number.isFinite(max)) return '';
      if(Math.abs(max - min) < 0.001){
        const adjust = Math.max(1, Math.abs(max) || 1);
        min -= adjust;
        max += adjust;
      }
      const scaleY = value => {
        const ratio = (value - min) / (max - min);
        return height - (ratio * height);
      };
      const stepX = points.length > 1 ? width / (points.length - 1) : width;
      let linePath = '';
      for(let i=0;i<points.length;i++){
        const x = points.length === 1 ? width : stepX * i;
        const y = scaleY(points[i]);
        linePath += (i===0 ? 'M' : 'L') + x.toFixed(2) + ' ' + y.toFixed(2) + ' ';
      }
      const zeroY = scaleY(0);
      let areaPath = `M0 ${zeroY.toFixed(2)} `;
      for(let i=0;i<points.length;i++){
        const x = points.length === 1 ? width : stepX * i;
        const y = scaleY(points[i]);
        areaPath += `L${x.toFixed(2)} ${y.toFixed(2)} `;
      }
      areaPath += `L${width.toFixed(2)} ${zeroY.toFixed(2)} Z`;
      const zeroLine = zeroY >=0 && zeroY <= height
        ? `<line class="spark-zero" x1="0" y1="${zeroY.toFixed(2)}" x2="${width.toFixed(2)}" y2="${zeroY.toFixed(2)}"></line>`
        : '';
      const markup = `
        <div class="spark" aria-hidden="true">
          <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
            <defs>
              <linearGradient id="${gradientId}" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="currentColor" stop-opacity="0.25"></stop>
                <stop offset="100%" stop-color="currentColor" stop-opacity="0"></stop>
              </linearGradient>
            </defs>
            ${zeroLine}
            <path class="spark-area" d="${areaPath.trim()}" fill="url(#${gradientId})"></path>
            <path class="spark-line" d="${linePath.trim()}" vector-effect="non-scaling-stroke"></path>
          </svg>
        </div>
      `;
      return markup.trim();
    }

    function renderSpark(row, field){
      const value = row[field];
      if(value==null){
        const emptyMarkup = `
        <div class="spark-wrap spark-neu">
          <div class="spark spark-empty" aria-hidden="true"></div>
          <span class="val neu-text">—</span>
        </div>
        `;
        return emptyMarkup.trim();
      }
      const baseKey = row._key || row.isin || row.symbol || row.name || '';
      const gradientId = `spark-${hashSeed(String(baseKey)+'|'+field).toString(36)}`;
      const series = sparkSeriesForField(row, field);
      const svg = series ? buildSparkSvg(series, gradientId) : '';
      if(!svg) return `<span class="val ${returnClass(value)}">${formatReturn(value)}</span>`;
      const tone = value>0 ? 'spark-pos' : value<0 ? 'spark-neg' : 'spark-neu';
      const markup = `
        <div class="spark-wrap ${tone}">
          ${svg}
          <span class="val ${returnClass(value)}">${formatReturn(value)}</span>
        </div>
      `;
      return markup.trim();
    }
    function resolveDisplayPrice(pi){
      if(!pi || typeof pi !== 'object'){
        return { price:null, decimals:null };
      }
      const pick = entry => {
        if(entry && Number.isFinite(entry.price) && entry.price > 0){
          return {
            price: entry.price,
            decimals: Number.isFinite(entry.decimals) ? entry.decimals : null,
          };
        }
        return null;
      };

      const last = pick(pi.last);
      if(last) return last;

      const close = pick(pi.close);
      if(close) return close;

      const bid = pick(pi.bid);
      const ask = pick(pi.ask);
      if(bid && ask){
        const decimals = bid.decimals ?? ask.decimals ?? null;
        return {
          price: (bid.price + ask.price) / 2,
          decimals,
        };
      }
      if(bid) return bid;
      if(ask) return ask;

      const open = pick(pi.open);
      if(open) return open;

      const high = pick(pi.high);
      if(high) return high;

      const low = pick(pi.low);
      if(low) return low;

      return { price:null, decimals:null };
    }
    const esc  = s => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));

    let all=[], base=[], view=[];
    let showPriceCurrency=false;
    let sortKey='yield_ytd', sortDir='desc';
    const ruleFields = [...RETURN_FIELDS];

    const columnFilters = { name:'', price:'', currency:'', owners:'10000' };


    const tableWrap = document.getElementById('tableWrap');
    const headerGrid = document.getElementById('headerGrid');
    const viewport=document.getElementById('viewport');
    const SCROLL_STORAGE_KEY='stats-scroll-top';
    const visitedKeys = new Set();
    let lastClickedKey = null;
    let pendingScrollTop=null;
    const spacer=document.getElementById('spacer');
    const countEl=document.getElementById('countBadge');
    const ruleInputs=Object.fromEntries(ruleFields.map(f=>[f,document.getElementById('rule-'+f)]));
    const nameFilterEl = document.getElementById('filter-name');
    const priceFilterEl = document.getElementById('filter-price');
    const currencyFilterEl = document.getElementById('filter-currency');
    const ownersFilterEl = document.getElementById('filter-owners');
    if(ownersFilterEl){
      ownersFilterEl.value = columnFilters.owners;
    }

    function formatPrice(price, decimals){
      if(price==null) return '—';
      const d = Number.isFinite(decimals) ? Math.min(Math.max(decimals, 0), 6) : 2;
      return Number(price).toLocaleString('en-US', {
        minimumFractionDigits: d,
        maximumFractionDigits: d,
      });
    }

    function hasColumnFilter(){
      return Object.values(columnFilters).some(val => (val || '').trim());
    }
    const togglePriceCurrencyBtn=document.getElementById('togglePriceCurrencyBtn');

    /* ---------- Filter input sanitization: accept only + - * ---------- */
    function sanitizeRuleInput(e){
      const v = (e.target.value || '').replace(/[^+\-*]/g,'');
      e.target.value = v.slice(0,1);
    }
    for(const f of ruleFields){
      const el = ruleInputs[f];
      el.addEventListener('input', sanitizeRuleInput);
      el.addEventListener('input', debounce(()=>applyRuleAndRefresh(), DEBOUNCE_RULE));
    }

    if(nameFilterEl){
      nameFilterEl.addEventListener('input', debounce(()=>{
        const val = (nameFilterEl.value || '').trim();
        nameFilterEl.value = val;
        columnFilters.name = val;
        pendingScrollTop=0;
        apply();
      }, DEBOUNCE));
    }

    if(priceFilterEl){
      priceFilterEl.addEventListener('input', debounce(()=>{
        const val = (priceFilterEl.value || '').trim();
        priceFilterEl.value = val;
        columnFilters.price = val;
        pendingScrollTop=0;
        apply();
      }, DEBOUNCE));
    }

    if(currencyFilterEl){
      currencyFilterEl.addEventListener('input', debounce(()=>{
        const val = (currencyFilterEl.value || '').toUpperCase().trim();
        currencyFilterEl.value = val;
        columnFilters.currency = val;
        pendingScrollTop=0;
        apply();
      }, DEBOUNCE));
    }

    if(ownersFilterEl){
      ownersFilterEl.addEventListener('input', debounce(()=>{
        const val = (ownersFilterEl.value || '').trim();
        ownersFilterEl.value = val;
        columnFilters.owners = val;
        pendingScrollTop=0;
        apply();
      }, DEBOUNCE));
    }

    function collectRule(){
      const rule={};
      for(const f of ruleFields){
        const v=(ruleInputs[f]?.value||'').trim();
        if(v==='+'||v==='-'||v==='*') rule[f]=v;
      }
      return rule;
    }
    function matchRule(row,rule){
      for(const [key,val] of Object.entries(rule)){
        const n=row[key];
        if(val==='+'&&!(n>0))return false;
        if(val==='-'&&!(n<0))return false;
        if(val==='*'&&!(n==null))return false; // star => only show missing values (renders as —)
      }
      return true;
    }
    const ruleIsEmpty = r => Object.keys(r).length===0;
    function applyRuleAndRefresh(){
      const rule=collectRule();
      base=ruleIsEmpty(rule)?all:all.filter(r=>matchRule(r,rule));
      pendingScrollTop=0;
      apply();
    }

    const sortIds=['name','price','currency','number_of_owners',...ruleFields];
    function setSortIndicator(){
      for(const id of sortIds){
        const el=document.getElementById('sort-'+id);
        if(el) el.textContent=(id===sortKey)?(sortDir==='asc'?'▲':'▼'):'';
      }
    }

    /* Two-line name on small screens: lift the hard truncate to ~40 chars there */
    function nameLimit(){
      return window.matchMedia('(max-width: 768px)').matches ? 40 : 20;
    }
    function truncateName(name){
      const s=String(name||'');
      const max = nameLimit();
      return s.length>max ? s.slice(0,max)+'…' : s;
    }

    function rowH(){
      const v = getComputedStyle(document.documentElement).getPropertyValue('--row-h').trim();
      const n = parseInt(v,10);
      return Number.isFinite(n) ? n : 44;
    }

    function matchesName(row, filter){
      const term = (filter || '').trim().toLowerCase();
      if(!term) return true;
      const value = (row.name || '').toLowerCase();
      return value.includes(term);
    }

    function matchesCurrency(row, filter){
      const term = (filter || '').trim().toLowerCase();
      if(!term) return true;
      const value = (row.currency || '').toLowerCase();
      return value.includes(term);
    }

    function matchesOwners(row, filter){
      const term = (filter || '').trim();
      if(!term) return true;
      const owners = row.number_of_owners;
      if(term === '*') return owners == null;
      const normalized = term.replace(/,/g,'');
      const range = normalized.match(/^(-?\d+(?:\.\d+)?)\s*-\s*(-?\d+(?:\.\d+)?)$/);
      if(range){
        if(owners==null) return false;
        const min = parseFloat(range[1]);
        const max = parseFloat(range[2]);
        if(Number.isNaN(min) || Number.isNaN(max)) return true;
        const lo = Math.min(min, max);
        const hi = Math.max(min, max);
        return owners >= lo && owners <= hi;
      }
      const comp = normalized.match(/^(<=|>=|<|>|=)\s*(-?\d+(?:\.\d+)?)$/);
      if(comp){
        if(owners==null) return false;
        const op = comp[1];
        const num = parseFloat(comp[2]);
        if(Number.isNaN(num)) return true;
        if(op==='>') return owners > num;
        if(op==='>=') return owners >= num;
        if(op==='<') return owners < num;
        if(op==='<=') return owners <= num;
        return owners === num;
      }
      if(owners==null) return false;
      if(/^-?\d+(?:\.\d+)?$/.test(normalized)){
        const num = parseFloat(normalized);
        if(Number.isNaN(num)) return true;
        return owners >= num;
      }
      const shown = owners.toLocaleString('en-US').toLowerCase();
      return shown.includes(term.toLowerCase());
    }

    function matchesPrice(row, filter){
      const term = (filter || '').trim();
      if(!term) return true;
      const price = row.price;
      if(price==null) return false;
      const normalized = term.replace(/,/g,'');
      const range = normalized.match(/^(-?\d+(?:\.\d+)?)\s*-\s*(-?\d+(?:\.\d+)?)$/);
      if(range){
        const min = parseFloat(range[1]);
        const max = parseFloat(range[2]);
        if(Number.isNaN(min) || Number.isNaN(max)) return true;
        const lo = Math.min(min, max);
        const hi = Math.max(min, max);
        return price >= lo && price <= hi;
      }
      const comp = normalized.match(/^(<=|>=|<|>|=)\s*(-?\d+(?:\.\d+)?)$/);
      if(comp){
        const op = comp[1];
        const num = parseFloat(comp[2]);
        if(Number.isNaN(num)) return true;
        if(op==='>') return price > num;
        if(op==='>=') return price >= num;
        if(op==='<') return price < num;
        if(op==='<=') return price <= num;
        return price === num;
      }
      const numeric = parseFloat(normalized);
      if(!Number.isNaN(numeric)){
        const shown = formatPrice(price, row.price_decimals).replace(/,/g,'');
        if(/^[-+]?\d*\.?\d*$/.test(normalized) && normalized.includes('.')){
          return shown.startsWith(normalized);
        }
        return shown.includes(normalized);
      }
      const shown = formatPrice(price, row.price_decimals).toLowerCase();
      return shown.includes(term.toLowerCase());
    }

        function buildRow(r){
          const url = r.display_slug ? `https://www.nordnet.se/aktier/kurser/${encodeURIComponent(r.display_slug)}` : '';
          const classes = ['row'];
          if (r._key && visitedKeys.has(r._key)) classes.push('row-visited');
          if (r._key && r._key === lastClickedKey) classes.push('row-active');
          const classAttr = classes.join(' ');
          const dataAttr = r._key ? ` data-row-key="${esc(r._key)}"` : '';
          const aAttr = url
            ? `href="${url}" target="_blank" rel="noopener" class="${classAttr}"${dataAttr}`
            : `class="${classAttr}"${dataAttr}`;
          return `
                <a ${aAttr} style="top:0">
                  <div><div class="name">${esc(truncateName(r.name))}</div></div>
                  <div class="right col-price"><span class="val">${formatPrice(r.price, r.price_decimals)}</span></div>
                  <div class="center col-currency"><span class="val">${r.currency ? esc(r.currency) : '—'}</span></div>
                  <div class="right col-owners"><span class="val">${r.number_of_owners!=null ? Number(r.number_of_owners).toLocaleString('en-US') : '—'}</span></div>
                  <div class="right">${renderSpark(r,'yield_1d')}</div>
                  <div class="right">${renderSpark(r,'yield_1w')}</div>
                  <div class="right">${renderSpark(r,'yield_1m')}</div>
                  <div class="right">${renderSpark(r,'yield_3m')}</div>
                  <div class="right">${renderSpark(r,'yield_ytd')}</div>
                  <div class="right">${renderSpark(r,'yield_1y')}</div>
                  <div class="right">${renderSpark(r,'yield_3y')}</div>
                  <div class="right">${renderSpark(r,'yield_5y')}</div>
                  <div class="right">${renderSpark(r,'yield_10y')}</div>
                  <div class="right">${renderSpark(r,'yield_max')}</div>
                </a>`;
        }

    function updateVisibleRowHighlights(){
      const rows = viewport.querySelectorAll('.row[data-row-key]');
      rows.forEach(rowEl => {
        const key = rowEl.getAttribute('data-row-key');
        if (!key) return;
        rowEl.classList.toggle('row-visited', visitedKeys.has(key));
        rowEl.classList.toggle('row-active', key === lastClickedKey);
      });
    }

    function rememberRowInteraction(key){
      if(!key) return;
      visitedKeys.add(key);
      lastClickedKey = key;
      updateVisibleRowHighlights();
    }


    function renderWindow(){
      const RH = rowH();
      const scrollTop=viewport.scrollTop;
      const height=viewport.clientHeight;
      const total=view.length;

      spacer.style.height=(total*RH)+'px';

      const first=Math.max(0,Math.floor(scrollTop/RH)-BUFFER);
      const need=Math.ceil(height/RH)+BUFFER*2;
      const count=Math.min(MAX_ROWS,Math.min(need,total-first));

      let html='';
      for(let i=0;i<count;i++){
        const idx=first+i;
        const r=view[idx]; if(!r) break;
        html+=buildRow(r).replace('top:0',`top:${idx*RH}px`);
      }

      while(viewport.children.length>1) viewport.removeChild(viewport.lastChild);
      const wrap=document.createElement('div');
      wrap.innerHTML=html;
      viewport.appendChild(wrap);
      updateVisibleRowHighlights();
    }

    const collator = new Intl.Collator(undefined, { sensitivity: 'base' });
    function stableSort(arr,key,dir){
      const mult=dir==='asc'?1:-1;
      return arr.map((v,i)=>({v,i})).sort((a,b)=>{
        const A=a.v[key];
        const B=b.v[key];

        const aMissing=A==null||A==='';
        const bMissing=B==null||B==='';
        if(aMissing&&bMissing)return a.i-b.i;
        if(aMissing)return 1;
        if(bMissing)return -1;

        const aNum=typeof A==='number';
        const bNum=typeof B==='number';
        if(aNum&&bNum){
          if(A===B)return a.i-b.i;
          return(A<B?-1:1)*mult;
        }

        const cmp=collator.compare(String(A),String(B));
        if(cmp===0)return a.i-b.i;
        return cmp*mult;
      }).map(x=>x.v);
    }

    function apply(){
      const RH = rowH();

      const filtered = base.filter(row =>
        matchesName(row, columnFilters.name) &&
        matchesPrice(row, columnFilters.price) &&
        matchesCurrency(row, columnFilters.currency) &&
        matchesOwners(row, columnFilters.owners)
      );

      view=stableSort(filtered,sortKey,sortDir);
      const filteredMsg = base!==all || hasColumnFilter();
      countEl.textContent=`${view.length.toLocaleString()} rows${filteredMsg?' (filtered)':''}`;
      spacer.style.height=(view.length*RH)+'px';
      const maxScroll = Math.max(0, view.length * RH - viewport.clientHeight);
      let targetScrollTop = pendingScrollTop;
      if(targetScrollTop==null) targetScrollTop = viewport.scrollTop;
      viewport.scrollTop = Math.min(Math.max(targetScrollTop, 0), maxScroll);
      pendingScrollTop=null;
      renderWindow();
      setSortIndicator();

      // keep body width in sync with header width to prevent cut-offs on horizontal scroll
      syncGridWidth();
    }

    function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}

    function syncGridWidth(){
      // Read header's scrollWidth and push to CSS var so rows span the same width
      const w = headerGrid.scrollWidth;
      document.documentElement.style.setProperty('--grid-width', w + 'px');
      spacer.style.width = w + 'px';
    }

    async function load(){
      const res=await fetch(DATA_URL);
      const json=await res.json();
      const results=Array.isArray(json?.results)?json.results:Array.isArray(json)?json:[];
      all=results.map(r=>{
        const ii=r.instrument_info||{};
        const hr=r.historical_returns_info||{};
        const ex=r.exchange_info||{};
        const nnx=r.nnx_info||{};
        const si=r.statistical_info||{};
        const pi=r.price_info||{};
        const resolved=resolveDisplayPrice(pi);
        const normalized={
          name:ii.long_name||ii.name||'',
          symbol:ii.symbol||'',
          isin:ii.isin||'',
          country:ex.exchange_country||'',
          display_slug:nnx.display_slug||'',
          price:nval(resolved.price),
          price_decimals:resolved.decimals,
          currency:ii.currency||ii.price_unit||'',
          number_of_owners:nval(si.number_of_owners),
          yield_1d:nval(hr.yield_1d),
          yield_1w:nval(hr.yield_1w),
          yield_1m:nval(hr.yield_1m),
          yield_3m:nval(hr.yield_3m),
          yield_ytd:nval(hr.yield_ytd),
          yield_1y:nval(hr.yield_1y),
          yield_3y:nval(hr.yield_3y),
          yield_5y:nval(hr.yield_5y),
          yield_10y: nval(hr.yield_10y),
          yield_max: nval(hr.yield_max),
        };
        normalized._key = keyOf(normalized);
        return normalized;
      });
      base=all;
      try{
        const stored=sessionStorage.getItem(SCROLL_STORAGE_KEY);
        const parsed=stored==null?null:Number.parseInt(stored,10);
        pendingScrollTop=Number.isFinite(parsed)?parsed:null;
      }catch{
        pendingScrollTop=null;
      }
      apply();
      syncGridWidth();
    }

    // sorting (only Name + return columns)
    document.querySelectorAll('[data-sort]').forEach(el=>{
      el.addEventListener('click',()=>{
        const key=el.getAttribute('data-sort');
        if(sortKey===key){sortDir=(sortDir==='asc'?'desc':'asc');}
        else{sortKey=key;sortDir=(key==='name')?'asc':'desc';}
        pendingScrollTop=0;
        apply();
      });
    });

    // reset
    document.getElementById('resetBtn').addEventListener('click',()=>{
      for(const f of ruleFields){ ruleInputs[f].value=''; }
      columnFilters.name=''; columnFilters.price=''; columnFilters.currency=''; columnFilters.owners='';
      if(nameFilterEl) nameFilterEl.value='';
      if(priceFilterEl) priceFilterEl.value='';
      if(currencyFilterEl) currencyFilterEl.value='';
      if(ownersFilterEl) ownersFilterEl.value='';
      sortKey='yield_ytd'; sortDir='desc';
      base=all; pendingScrollTop=0; apply();
      showPriceCurrency=false;
      updatePriceCurrencyVisibility();
    });
	// refresh (reloads the whole page)
        document.getElementById('refreshBtn').addEventListener('click', () => {
          location.reload();
        });
	// new shares (diff latest vs previous)
	document.getElementById('newSharesBtn').addEventListener('click', () => {
	  showNewShares();
	});
	// get latest (copy text then open Nordnet)
        document.getElementById('getLatestBtn').addEventListener('click', async () => {
          try {
                // Fetch TheScript.txt (must be in the same folder as index.html)
                const res = await fetch('./TheScript.txt');
                if (!res.ok) throw new Error('Could not load TheScript.txt');
                const text = await res.text();

		// Copy text to clipboard
		await navigator.clipboard.writeText(text);

		// Open Nordnet site in new tab
		window.open('https://www.nordnet.se/aktier/kurser', '_blank');
	  } catch (err) {
		alert('Failed to copy TheScript.txt: ' + err.message);
		console.error(err);
	  }
        });

    function updatePriceCurrencyVisibility(){
      if(!togglePriceCurrencyBtn) return;
      document.body.classList.toggle('show-price-currency', showPriceCurrency);
      togglePriceCurrencyBtn.setAttribute('aria-pressed', String(showPriceCurrency));
      togglePriceCurrencyBtn.textContent = showPriceCurrency ? 'Hide' : 'Show';
      syncGridWidth();
      renderWindow();
    }

    if(togglePriceCurrencyBtn){
      togglePriceCurrencyBtn.addEventListener('click', ()=>{
        showPriceCurrency=!showPriceCurrency;
        updatePriceCurrencyVisibility();
      });
    }

    updatePriceCurrencyVisibility();

    // Keep header right padding aligned with body vertical scrollbar width
    function syncHeaderPadding(){
      const sbw = viewport.offsetWidth - viewport.clientWidth;
      headerGrid.style.paddingLeft  = '12px';
      headerGrid.style.paddingRight = (12 + sbw) + 'px';
    }

    // listen for size changes
    new ResizeObserver(()=>{ syncHeaderPadding(); syncGridWidth(); apply(); }).observe(viewport);
    new ResizeObserver(()=>{ syncHeaderPadding(); syncGridWidth(); }).observe(headerGrid);
    window.addEventListener('resize', ()=>{ syncHeaderPadding(); syncGridWidth(); apply(); });

    // vertical virtualization
    function saveScrollPosition(){
      try{
        sessionStorage.setItem(SCROLL_STORAGE_KEY, String(Math.round(viewport.scrollTop)));
      }catch{}
    }
    const debouncedSaveScroll=debounce(saveScrollPosition,150);
    viewport.addEventListener('scroll',()=>{
      renderWindow();
      debouncedSaveScroll();
    });
    window.addEventListener('pagehide', saveScrollPosition);
    window.addEventListener('beforeunload', saveScrollPosition);

    // initial load (resolve latest JSON first)
    (async ()=>{
      try{ DATA_URL = await resolveLatestDataUrl(); } catch(_) {}
      await load();
    })();
	
function handleRowSelection(event, { copyName = true } = {}){
  const row = event.target.closest('.row');
  if (!row) return;

  const key = row.getAttribute('data-row-key');
  if (key) rememberRowInteraction(key);

  const nameEl = row.querySelector('.name');
  const textToCopy = nameEl ? nameEl.textContent.trim() : '';

  try {
    sessionStorage.setItem(SCROLL_STORAGE_KEY, String(Math.round(viewport.scrollTop)));
  } catch {}

  if (!copyName || !textToCopy) return;

  const copyWithFallback = (txt) => {
    const ta = document.createElement('textarea');
    ta.value = txt;
    ta.setAttribute('readonly', '');
    ta.style.position = 'fixed';
    ta.style.top = '-1000px';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); } catch {}
    document.body.removeChild(ta);
  };

  const canUseClipboardAPI =
    navigator?.clipboard &&
    typeof navigator.clipboard.writeText === 'function' &&
    window.isSecureContext;

  if (canUseClipboardAPI) {
    navigator.clipboard.writeText(textToCopy).catch(() => copyWithFallback(textToCopy));
  } else {
    copyWithFallback(textToCopy);
  }

  try {
    countEl.textContent = `Copied: ${textToCopy}`;
    setTimeout(apply, 1200);
  } catch {}
}

viewport.addEventListener('click', (event) => {
  handleRowSelection(event, { copyName: true });
});

viewport.addEventListener('auxclick', (event) => {
  if (event.button !== 1) return; // only track middle-clicks that open a new tab
  handleRowSelection(event, { copyName: false });
});

  </script>
</body>
</html>
