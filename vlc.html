<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PakStream • Player</title>
  <link rel="preconnect" href="https://cdn.plyr.io" />
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#11151d; --panel2:#0e141c; --text:#e6edf3; --muted:#93a4ba; --accent:#e50914; --pill:#2a3342; --ok:#27d49a;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    .nav{display:flex;align-items:center;gap:18px;padding:14px 22px;border-bottom:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));position:sticky;top:0;z-index:10}
    .brand{font-weight:800;letter-spacing:.5px}
    .brand .dot{color:var(--accent)}
    .nav .spacer{flex:1}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,.16)}

    .layout{max-width:1200px;margin:14px auto;padding:0 16px;display:grid;grid-template-columns:350px 1fr;gap:16px}
    @media (max-width:1000px){.layout{grid-template-columns:1fr}}

    /* LEFT: details */
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);overflow:hidden}
    .poster{aspect-ratio:2/3;background:var(--panel2) center/cover no-repeat}
    .meta{padding:16px}
    .title{font-size:22px;font-weight:800;margin:0 0 6px}
    .row{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px;margin-bottom:8px}
    .pill{background:var(--pill);padding:4px 8px;border-radius:999px;color:#cfe0ff}

    /* RIGHT: player + rail */
    .player-card{padding:12px}
    .player-wrap{position:relative}
    .plyr--video{border-radius:16px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.55)}
    .hero-actions{display:flex;gap:10px;align-items:center;margin:12px 4px 0}
    .hint{color:var(--muted);font-size:12px}

    /* Episodes / playlist */
    .episodes{margin:14px 0 0;padding:0 12px 16px}
    .episodes h3{margin:8px 0 10px;font-size:16px}
    .ep-list{display:flex;overflow:auto;gap:12px;padding-bottom:6px}
    .ep{min-width:240px;background:var(--panel2);border:1px solid rgba(255,255,255,.08);border-radius:14px;cursor:pointer}
    .thumb{height:120px;border-bottom:1px solid rgba(255,255,255,.06);background:#0a0f14 center/cover no-repeat}
    .ep .txt{padding:10px}
    .ep .name{font-weight:700}
    .ep .sub{color:var(--muted);font-size:12px}
    .ep.active{outline:2px solid var(--accent)}

    /* Rail */
    .rail{padding:8px 12px 20px}
    .rail h3{margin:10px 0}
    .tiles{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media (max-width:1100px){.tiles{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:700px){.tiles{grid-template-columns:repeat(2,1fr)}}
    .tile{aspect-ratio:16/9;background:#0e141c center/cover no-repeat;border-radius:12px;border:1px solid rgba(255,255,255,.08);position:relative;overflow:hidden}
    .tile::after{content:"";position:absolute;inset:0;box-shadow:inset 0 -60px 100px rgba(0,0,0,.6)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
    .sheet{background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:16px;max-width:560px;width:100%;padding:16px}
    .sheet h3{margin:0 0 8px}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .input{width:100%;padding:12px;background:#0e141c;border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--text)}

    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;}
    .overlay .box{background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.2);padding:16px 18px;border-radius:12px;display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="brand">PakStream<span class="dot">•</span>Player</div>
    <div class="spacer"></div>
    <button class="btn ghost" id="addUrl">+ Add From URL</button>
  </nav>

  <div class="layout">
    <!-- LEFT: Poster + meta -->
    <aside class="card">
      <div id="poster" class="poster" style="background-image:url('https://image.tmdb.org/t/p/w500/9KQgG8GMDIS9ZhDJW60TrNRXS6a.jpg');"></div>
      <div class="meta">
        <h2 class="title" id="title">The Legend of Bagger Vance</h2>
        <div class="row">
          <span class="pill">2000</span>
          <span class="pill">2h 7m</span>
          <span class="pill">Drama</span>
        </div>
        <div class="row">Press <b>Space</b> to play/pause • <b>F</b> fullscreen • <b>→/←</b> seek • <b>N</b> next</div>
        <div class="row hint">Add your own link with <b>+ Add From URL</b>. MP4/WebM work best. HLS needs CORS.</div>
      </div>
    </aside>

    <!-- RIGHT: Player -->
    <section class="card player-card">
      <div class="player-wrap" id="playerWrap">
        <video id="player" playsinline controls></video>
      </div>
      <div class="hero-actions">
        <button class="btn" id="playDemo">▶ Play Demo</button>
        <button class="btn ghost" id="playDemoHls">▶ Play Demo (HLS)</button>
        <span class="hint" id="tip">Ready.</span>
      </div>

      <div class="episodes">
        <h3>Playlist</h3>
        <div id="epList" class="ep-list"></div>
      </div>

      <div class="rail">
        <h3>Because you watched</h3>
        <div class="tiles">
          <div class="tile" style="background-image:url('https://picsum.photos/seed/ps1/800/450')"></div>
          <div class="tile" style="background-image:url('https://picsum.photos/seed/ps2/800/450')"></div>
          <div class="tile" style="background-image:url('https://picsum.photos/seed/ps3/800/450')"></div>
          <div class="tile" style="background-image:url('https://picsum.photos/seed/ps4/800/450')"></div>
          <div class="tile" style="background-image:url('https://picsum.photos/seed/ps5/800/450')"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal: Add URL -->
  <div class="modal" id="modal">
    <div class="sheet">
      <h3>Add stream</h3>
      <div class="grid">
        <input class="input" id="m_url" placeholder="https://host/path/video.mp4 or https://host/stream/index.m3u8" />
        <div class="grid grid-2">
          <input class="input" id="m_poster" placeholder="Poster (optional)" />
          <input class="input" id="m_subs" placeholder="Subtitles .vtt (optional)" />
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn ghost" id="m_cancel">Cancel</button>
          <button class="btn" id="m_add">Add to Playlist</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
  <script>
    // ---------- Persistence Keys ----------
    const LS_KEYS = {
      playlist: 'ps_playlist_v1',
      idx: 'ps_current_index_v1',
      tmap: 'ps_time_by_src_v1',
      lastsrc: 'ps_last_src_v1'
    };

    // ---------- Utilities ----------
    const throttle = (fn, ms) => { let t=0; return (...a)=>{ const n=Date.now(); if(n-t>ms){ t=n; fn(...a); } } };

    function getTimeMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.tmap) || '{}'); }catch(e){ return {}; } }
    function setTimeFor(src, sec){ const m=getTimeMap(); m[src]=sec; localStorage.setItem(LS_KEYS.tmap, JSON.stringify(m)); }
    function getTimeFor(src){ const m=getTimeMap(); return m[src]||0; }

    function savePlaylist(){ localStorage.setItem(LS_KEYS.playlist, JSON.stringify(playlist)); }
    function saveIndex(){ localStorage.setItem(LS_KEYS.idx, String(current)); const ep=playlist[current]; if(ep) localStorage.setItem(LS_KEYS.lastsrc, ep.src); }
    function loadState(){
      try{
        const p = JSON.parse(localStorage.getItem(LS_KEYS.playlist) || '[]');
        if(Array.isArray(p) && p.length) playlist = p;
        const idxStr = localStorage.getItem(LS_KEYS.idx);
        if(idxStr!==null) current = parseInt(idxStr,10);
      }catch(e){}
    }
    function clearTimeForCurrent(){ const ep=playlist[current]; if(!ep) return; const m=getTimeMap(); delete m[ep.src]; localStorage.setItem(LS_KEYS.tmap, JSON.stringify(m)); }
    function safeHost(u){ try{return new URL(u).hostname;}catch(e){return '';} }
    function fmtTime(sec){ sec=Math.floor(sec); const m=Math.floor(sec/60), s=sec%60; return `${m}:${String(s).padStart(2,'0')}`; }

    // ---------- UI Elements ----------
    const tip = document.getElementById('tip');
    const posterEl = document.getElementById('poster');
    const titleEl = document.getElementById('title');
    const epList = document.getElementById('epList');
    const playerWrap = document.getElementById('playerWrap');

    const video = document.getElementById('player');
    const plyr = new Plyr(video, {
      ratio: '16:9',
      controls: ['play-large','play','progress','current-time','duration','mute','volume','captions','settings','pip','airplay','fullscreen'],
      settings: ['captions','speed','quality','loop']
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if(e.key===' '){ e.preventDefault(); plyr.togglePlay(); }
      if(e.key==='f'){ plyr.fullscreen.toggle(); }
      if(e.key==='ArrowRight'){ plyr.forward(10); }
      if(e.key==='ArrowLeft'){ plyr.rewind(10); }
      if(e.key.toLowerCase()==='n'){ playNext(); }
    });

    // ---------- Playlist Model ----------
    let playlist = [];
    let current = -1;

    function addToPlaylist({name, src, poster='', subs=''}){
      const id='ep'+Math.random().toString(36).slice(2);
      playlist.push({id,name,src,poster,subs});
      savePlaylist();
      renderPlaylist();
    }

    function renderPlaylist(){
      epList.innerHTML='';
      playlist.forEach((ep, idx)=>{
        const el=document.createElement('div');
        el.className='ep'+(idx===current?' active':'');
        el.innerHTML = `
          <div class="thumb" style="background-image:url('${ep.poster||'https://picsum.photos/seed/'+idx+'/400/225'}')"></div>
          <div class="txt">
            <div class="name">${ep.name||'Untitled'}</div>
            <div class="sub">${safeHost(ep.src)}</div>
          </div>`;
        el.addEventListener('click', ()=> playIndex(idx));
        epList.appendChild(el);
      });
    }

    function setQualityMenuFromHls(hls){
      const levels = hls.levels.map(l=>l.height).filter(Boolean).sort((a,b)=>a-b);
      plyr.options.quality = {
        default: levels[levels.length-1]||0,
        options: [...new Set(levels)],
        forced: true,
        onChange: (q)=>{ const idx = hls.levels.findIndex(l=>l.height===q); hls.currentLevel = idx; }
      };
    }

    function makeResumeOverlay(saved){
      const wrap = document.createElement('div');
      wrap.className='overlay';
      wrap.id='resumeOverlay';
      wrap.innerHTML = `
        <div class="box">
          <span>Resume from <b>${fmtTime(saved)}</b>?</span>
          <button id="resumeYes" class="btn">Resume</button>
          <button id="resumeNo" class="btn ghost">Start Over</button>
        </div>`;
      return wrap;
    }

    function handleResume(src, resumeIfSame){
      const lastSrc = localStorage.getItem(LS_KEYS.lastsrc);
      const lastIdx = parseInt(localStorage.getItem(LS_KEYS.idx)||'-1',10);
      const saved = getTimeFor(src);
      const sameItem = (src===lastSrc) && (current===lastIdx);
      if(!(resumeIfSame && saved>0 && sameItem)) return;

      const show = ()=>{
        const duration = plyr.duration || video.duration || 0;
        if(duration && duration - saved < 30){ clearTimeForCurrent(); return; }
        const existing = document.getElementById('resumeOverlay');
        if(existing) existing.remove();
        const ov = makeResumeOverlay(saved);
        playerWrap.appendChild(ov);
        document.getElementById('resumeYes').onclick = ()=>{ video.currentTime=Math.max(0,saved-2); plyr.play(); ov.remove(); };
        document.getElementById('resumeNo').onclick = ()=>{ clearTimeForCurrent(); plyr.play(); ov.remove(); };
      };

      if(video.readyState>=1) show(); else video.addEventListener('loadedmetadata', show, {once:true});
    }

    function playIndex(idx, {resumeIfSame=true}={}){
      if(idx<0 || idx>=playlist.length) return;
      current = idx; saveIndex();
      const {src, poster, subs, name} = playlist[idx];
      titleEl.textContent = name || 'Untitled';
      posterEl.style.backgroundImage = `url('${poster||'https://picsum.photos/seed/p'+idx+'/600/900'}')`;
      tip.textContent = 'Loading…';

      // reset
      plyr.stop();
      video.removeAttribute('src');
      [...video.querySelectorAll('track')].forEach(t=>t.remove());
      video.load();

      if(subs){
        const track=document.createElement('track');
        track.kind='subtitles'; track.label='Subtitles'; track.srclang='en'; track.default=true; track.src=subs; video.appendChild(track);
      }

      const isHls = /\.m3u8($|\?)/i.test(src);
      try{
        if(isHls && window.Hls && Hls.isSupported()){
          video.setAttribute('crossorigin','anonymous');
          if(window._hls){ window._hls.destroy(); }
          const hls = new Hls({ xhrSetup: (xhr)=>{ xhr.withCredentials = false; } });
          window._hls = hls;
          hls.loadSource(src);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, ()=>{ setQualityMenuFromHls(hls); tip.textContent='Playing via HLS'; handleResume(src, resumeIfSame); plyr.play(); });
          hls.on(Hls.Events.ERROR, (evt, data)=>{ if(data.fatal){ tip.textContent='HLS fatal error: '+data.type; }});
        } else if(isHls && video.canPlayType('application/vnd.apple.mpegurl')){
          video.setAttribute('crossorigin','anonymous');
          video.src = src; video.addEventListener('loadedmetadata', ()=>{ tip.textContent='Playing HLS (native)'; handleResume(src, resumeIfSame); plyr.play(); }, {once:true});
        } else {
          // MP4/WebM — avoid CORS mode
          video.removeAttribute('crossorigin');
          video.src = src; video.addEventListener('loadedmetadata', ()=>{ tip.textContent='Playing file'; handleResume(src, resumeIfSame); plyr.play(); }, {once:true});
        }
      }catch(e){ tip.textContent = 'Could not load media (possible CORS).'; }

      renderPlaylist();
    }

    function playNext(){ if(current+1 < playlist.length){ clearTimeForCurrent(); playIndex(current+1, {resumeIfSame:false}); } }

    // Persist current time every second (per-src)
    video.addEventListener('timeupdate', throttle(()=>{ if(!isNaN(video.currentTime) && playlist[current]) setTimeFor(playlist[current].src, Math.floor(video.currentTime)); }, 1000));
    window.addEventListener('beforeunload', ()=>{ if(!isNaN(video.currentTime) && playlist[current]) setTimeFor(playlist[current].src, Math.floor(video.currentTime)); });

    // Modal controls
    const modal = document.getElementById('modal');
    const addBtn = document.getElementById('addUrl');
    const m_url = document.getElementById('m_url');
    const m_poster = document.getElementById('m_poster');
    const m_subs = document.getElementById('m_subs');
    const m_cancel = document.getElementById('m_cancel');
    const m_add = document.getElementById('m_add');

    function openModal(){ modal.style.display='flex'; setTimeout(()=>m_url.focus(),0); }
    function closeModal(){ modal.style.display='none'; }

    addBtn.addEventListener('click', openModal);
    m_cancel.addEventListener('click', closeModal);
    m_add.addEventListener('click', ()=>{
      const url = m_url.value.trim(); if(!url) return;
      const poster = m_poster.value.trim();
      const subs = m_subs.value.trim();
      addToPlaylist({name: url.split('/').pop(), src: url, poster, subs});
      closeModal();
      m_url.value = m_poster.value = m_subs.value = '';
      if(current===-1) playIndex(0);
    });

    // Demo buttons
    document.getElementById('playDemo').addEventListener('click', ()=>{
      addToPlaylist({name:'Big Buck Bunny (Demo MP4)', src:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4', poster:'https://peach.blender.org/wp-content/uploads/title_anouncement.jpg'});
      playIndex(playlist.length-1, {resumeIfSame:false});
    });
    document.getElementById('playDemoHls').addEventListener('click', ()=>{
      addToPlaylist({name:'MUX Test (Demo HLS)', src:'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'});
      playIndex(playlist.length-1, {resumeIfSame:false});
    });

    // ---------- Boot: restore previous session ----------
    loadState();
    renderPlaylist();
    if(playlist.length){
      if(current>=0 && current<playlist.length){ playIndex(current, {resumeIfSame:true}); }
    } else {
      // Seed a starter card so the page looks alive
      addToPlaylist({name:'Sample Trailer', src:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4', poster:'https://picsum.photos/seed/poster1/600/900'});
    }
  </script>
</body>
</html>
