<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PakStream • Player</title>
  <link rel="preconnect" href="https://cdn.plyr.io" />
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <link rel="stylesheet" href="assets/css/vlc-fullscreen.css" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#11151d; --panel2:#0e141c; --text:#e6edf3; --muted:#93a4ba; --accent:#e50914; --pill:#2a3342; --ok:#27d49a;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    .nav{display:flex;align-items:center;gap:18px;padding:14px 22px;border-bottom:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));position:sticky;top:0;z-index:10}
    .brand{font-weight:800;letter-spacing:.5px}
    .brand .dot{color:var(--accent)}
    .nav .spacer{flex:1}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,.16)}

    .layout{max-width:1200px;margin:14px auto;padding:0 16px;}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);overflow:hidden}

    /* RIGHT: player + rail */
    .player-card{padding:12px}
    .player-wrap{position:relative}
    .plyr--video{border-radius:16px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.55)}
    .hero-actions{display:flex;gap:10px;align-items:center;margin:12px 4px 0}
    .hint{color:var(--muted);font-size:12px}

    /* Episodes / playlist */
    .episodes{margin:14px 0 0;padding:0 12px 16px}
    .episodes h3{margin:8px 0 10px;font-size:16px}
    .ep-list{display:flex;overflow:auto;gap:12px;padding-bottom:6px}
    .ep{min-width:240px;background:var(--panel2);border:1px solid rgba(255,255,255,.08);border-radius:14px;cursor:pointer}
    .thumb{height:120px;border-bottom:1px solid rgba(255,255,255,.06);background:#0a0f14 center/cover no-repeat}
    .ep .txt{padding:10px}
    .ep .name{font-weight:700}
    .ep .sub{color:var(--muted);font-size:12px}
    .ep.active{outline:2px solid var(--accent)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
    .sheet{background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:16px;max-width:560px;width:100%;padding:16px}
    .sheet h3{margin:0 0 8px}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .input{width:100%;padding:12px;background:#0e141c;border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--text)}

    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;}
    .overlay .box{background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.2);padding:16px 18px;border-radius:12px;display:flex;gap:10px;align-items:center}
    #suggestions{position:absolute;background:var(--panel2);border:1px solid rgba(255,255,255,.16);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.4);max-height:240px;overflow-y:auto;display:none;z-index:1000;}
    #suggestions .item{padding:8px 10px;cursor:pointer;}
    #suggestions .item:hover,#suggestions .item.active{background:rgba(255,255,255,.08);}
  </style>
</head>
<body>

  <!-- Archive.org Search -->
  <section class="card" style="max-width:1200px;margin:14px auto;padding:12px 16px">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <input id="searchBox" class="input" placeholder='Search Archive.org videos (e.g. "Charlie Chaplin")' style="flex:1; min-width:240px" />
      <div id="suggestions"></div>
      <button id="archSearchBtn" class="btn">Search Archive.org</button>
      <small class="hint">Video-only, shows duration when available. Uses Archive.org public API.</small>
    </div>
    <div id="archResults" style="margin-top:12px; display:grid; gap:10px"></div>
  </section>

  <nav class="nav">
    <div class="brand">PakStream<span class="dot">•</span>Player</div>
    <div class="spacer"></div>
    <button class="btn ghost" id="addUrl">+ Add From URL</button>
  </nav>

  <div class="layout">
    <section class="card player-card">
      <div class="player-wrap" id="playerWrap">
        <video id="player" playsinline crossorigin="anonymous"></video>
        <div class="fs-controls" id="fsControls">
          <button id="centerPlay" class="play-center" aria-label="Play/Pause"></button>
          <button id="skipBack" class="skip-back" aria-label="Back 10 seconds">
            <svg viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.99 5V1l-5 5 5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6h-2c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8zm-1.1 11h-.85v-3.26l-1.01.31v-.69l1.77-.63h.09V16zm4.28-1.76c0 .32-.03.6-.1.82s-.17.42-.29.57-.28.26-.45.33-.37.1-.59.1-.41-.03-.59-.1-.33-.18-.46-.33-.23-.34-.3-.57-.11-.5-.11-.82v-.74c0-.32.03-.6.1-.82s.17-.42.29-.57.28-.26.45-.33.37-.1.59-.1.41.03.59.1.33.18.46.33.23.34.3.57.11.5.11.82v.74zm-.85-.86c0-.19-.01-.35-.04-.48s-.07-.23-.12-.31-.11-.14-.19-.17-.16-.05-.25-.05-.18.02-.25.05-.14.09-.19.17-.09.18-.12.31-.04.29-.04.48v.97c0 .19.01.35.04.48s.07.24.12.32.11.14.19.17.16.05.25.05.18-.02.25-.05.14-.09.19-.17.09-.19.11-.32.04-.29.04-.48v-.97z"/></svg>
          </button>
          <button id="skipForward" class="skip-forward" aria-label="Forward 10 seconds">
            <svg viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18 13c0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6v4l5-5-5-5v4c-4.42 0-8 3.58-8 8 0 4.42 3.58 8 8 8s8-3.58 8-8h-2z"/><polygon points="10.9,16 10.9,11.73 10.81,11.73 9.04,12.36 9.04,13.05 10.05,12.74 10.05,16"/><path d="M14.32 11.78c-.18-.07-.37-.1-.59-.1s-.41.03-.59.1-.33.18-.45.33-.23.34-.29.57-.1.5-.1.82v.74c0 .32.04.6.11.82s.17.42.3.57.28.26.46.33.37.1.59.1.41-.03.59-.1.33-.18.45-.33.22-.34.29-.57.1-.5.1-.82V13.5c0-.32-.04-.6-.11-.82s-.17-.42-.3-.57-.28-.26-.46-.33zM14.33 14.35c0 .19-.01.35-.04.48s-.06.24-.11.32-.11.14-.19.17-.16.05-.25.05-.18-.02-.25-.05-.14-.09-.19-.17-.09-.19-.12-.32-.04-.29-.04-.48v-.97c0-.19.01-.35.04-.48s.06-.23.12-.31.11-.14.19-.17.16-.05.25-.05.18.02.25.05.14.09.19.17.09.18.12.31.04.29.04.48v.97z"/></svg>
          </button>
          <div class="toolbar">
            <button id="toolbarPlay" aria-label="Play/Pause"></button>
            <input type="range" id="progress" value="0" min="0" step="0.1">
            <button id="fsToggle" aria-label="Toggle Fullscreen"></button>
          </div>
        </div>
      </div>
      <div class="hero-actions">
        <span class="hint" id="tip">Ready.</span>
      </div>

      <div class="episodes">
        <h3>Playlist</h3>
        <div id="epList" class="ep-list"></div>
      </div>
    </section>
  </div>

  <!-- Modal: Add URL -->
  <div class="modal" id="modal">
    <div class="sheet">
      <h3>Add stream</h3>
      <div class="grid">
        <input class="input" id="m_url" placeholder="https://host/path/video.mp4 or https://host/stream/index.m3u8" />
        <div class="grid grid-2">
          <input class="input" id="m_poster" placeholder="Poster (optional)" />
          <input class="input" id="m_subs" placeholder="Subtitles .vtt (optional)" />
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn ghost" id="m_cancel">Cancel</button>
          <button class="btn" id="m_add">Add to Playlist</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
  <script src="assets/js/vlc-fullscreen.js"></script>
  <script>
    // ---------- Persistence Keys ----------
    const LS_KEYS = {
      playlist: 'ps_playlist_v1',
      idx: 'ps_current_index_v1',
      tmap: 'ps_time_by_src_v1',
      lastsrc: 'ps_last_src_v1'
    };
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/16kreaQ7lxmx4FzljUeWtb4AbBowcixXd5UyvediK7vI/export?format=csv';

    // ---------- Utilities ----------
    const throttle = (fn, ms) => { let t=0; return (...a)=>{ const n=Date.now(); if(n-t>ms){ t=n; fn(...a); } } };

    function getTimeMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.tmap) || '{}'); }catch(e){ return {}; } }
    function setTimeFor(src, sec){ const m=getTimeMap(); m[src]=sec; localStorage.setItem(LS_KEYS.tmap, JSON.stringify(m)); }
    function getTimeFor(src){ const m=getTimeMap(); return m[src]||0; }

    function savePlaylist(){ localStorage.setItem(LS_KEYS.playlist, JSON.stringify(playlist)); }
    function saveIndex(){ localStorage.setItem(LS_KEYS.idx, String(current)); const ep=playlist[current]; if(ep) localStorage.setItem(LS_KEYS.lastsrc, ep.src); }
    function loadState(){
      try{
        const p = JSON.parse(localStorage.getItem(LS_KEYS.playlist) || '[]');
        if(Array.isArray(p) && p.length) playlist = p.map(ep=>({...ep, name: cleanName(ep.name||'')}));
        const idxStr = localStorage.getItem(LS_KEYS.idx);
        if(idxStr!==null) current = parseInt(idxStr,10);
      }catch(e){}
    }
    function clearTimeForCurrent(){ const ep=playlist[current]; if(!ep) return; const m=getTimeMap(); delete m[ep.src]; localStorage.setItem(LS_KEYS.tmap, JSON.stringify(m)); }
    function safeHost(u){ try{return new URL(u).hostname;}catch(e){return '';} }
    function fmtTime(sec){ sec=Math.floor(sec); const m=Math.floor(sec/60), s=sec%60; return `${m}:${String(s).padStart(2,'0')}`; }

    // ---------- UI Elements ----------
    const tip = document.getElementById('tip');
    const epList = document.getElementById('epList');
    const playerWrap = document.getElementById('playerWrap');

    const video = document.getElementById('player');
    const plyr = new Plyr(video, {
      ratio: '16:9',
      controls: [],
      settings: ['captions','speed','quality','loop']
    });
    initVlcFullscreen({ video, plyr, wrap: playerWrap });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if(e.key===' '){ e.preventDefault(); togglePlay(); }
      if(e.key==='f'){ toggleFullscreen(); }
      if(e.key==='ArrowRight'){ skipForward(); }
      if(e.key==='ArrowLeft'){ skipBack(); }
      if(e.key.toLowerCase()==='n'){ playNext(); }
    });

    // ---------- Playlist Model ----------
    let playlist = [];
    let current = -1;

    function cleanName(raw){
      if(!raw) return '';
      let name = decodeURIComponent(raw);
      name = name.replace(/\.[^./]+$/, '');
      name = name.replace(/[._-]+/g, ' ');
      name = name.replace(/\[[^\]]*\]/g, ' ');
      const trash = ['WEBRip','WEB-DL','HDRip','BluRay','BRRip','DVDRip','x264','x265','h264','h265','YTS','YIFY','1080p','720p','480p'];
      trash.forEach(t=>{
        const re = new RegExp('\\b'+t.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&')+'\\b','gi');
        name = name.replace(re,'');
      });
      return name.replace(/\s+/g,' ').trim();
    }

    function addToPlaylist({name, src, poster='', subs=''}){
      const id='ep'+Math.random().toString(36).slice(2);
      const nice = cleanName(name || src.split('/').pop());
      playlist.push({id,name:nice,src,poster,subs});
      savePlaylist();
      renderPlaylist();
    }

    function renderPlaylist(){
      epList.innerHTML='';
      playlist.forEach((ep, idx)=>{
        const el=document.createElement('div');
        el.className='ep'+(idx===current?' active':'');
        el.innerHTML = `
          <div class="thumb" style="background-image:url('${ep.poster||'https://picsum.photos/seed/'+idx+'/400/225'}')"></div>
          <div class="txt">
            <div class="name">${ep.name||'Untitled'}</div>
            <div class="sub">${safeHost(ep.src)}</div>
          </div>`;
        el.addEventListener('click', ()=> playIndex(idx));
        epList.appendChild(el);
      });
    }

    async function loadDefaults(){
      try{
        const res = await fetch('assets/default_playlist.json');
        const list = await res.json();
        if(Array.isArray(list)){
          list.forEach(ep=>{
            if(!playlist.some(p=>p.src===ep.src)){
              const id='ep'+Math.random().toString(36).slice(2);
              playlist.push({id, name: cleanName(ep.name || ep.src.split('/').pop()), src: ep.src, poster: ep.poster||'', subs: ep.subs||''});
            }
          });
          savePlaylist();
        }
      }catch(e){}
    }

    async function loadSheet(){
      try{
        const res = await fetch(SHEET_CSV);
        const text = await res.text();
        text.split(/\r?\n/).map(r=>r.trim()).forEach(url=>{
          if(!url || !/^https?:/i.test(url)) return;
          if(!playlist.some(p=>p.src===url)){
            const id='ep'+Math.random().toString(36).slice(2);
            playlist.push({id, name: cleanName(url.split('/').pop()), src:url, poster:'', subs:''});
          }
        });
        savePlaylist();
      }catch(e){ console.error('[PakStream] loadSheet error', e); }
    }

    function setQualityMenuFromHls(hls){
      const levels = hls.levels.map(l=>l.height).filter(Boolean).sort((a,b)=>a-b);
      plyr.options.quality = {
        default: levels[levels.length-1]||0,
        options: [...new Set(levels)],
        forced: true,
        onChange: (q)=>{ const idx = hls.levels.findIndex(l=>l.height===q); hls.currentLevel = idx; }
      };
    }

    function makeResumeOverlay(saved){
      const wrap = document.createElement('div');
      wrap.className='overlay';
      wrap.id='resumeOverlay';
      wrap.innerHTML = `
        <div class="box">
          <span>Resume from <b>${fmtTime(saved)}</b>?</span>
          <button id="resumeYes" class="btn">Resume</button>
          <button id="resumeNo" class="btn ghost">Start Over</button>
        </div>`;
      return wrap;
    }

    function handleResume(src, resumeIfSame){
      const lastSrc = localStorage.getItem(LS_KEYS.lastsrc);
      const lastIdx = parseInt(localStorage.getItem(LS_KEYS.idx)||'-1',10);
      const saved = getTimeFor(src);
      const sameItem = (src===lastSrc) && (current===lastIdx);
      if(!(resumeIfSame && saved>0 && sameItem)) return;

      const show = ()=>{
        const duration = plyr.duration || video.duration || 0;
        if(duration && duration - saved < 30){ clearTimeForCurrent(); return; }
        const existing = document.getElementById('resumeOverlay');
        if(existing) existing.remove();
        const ov = makeResumeOverlay(saved);
        playerWrap.appendChild(ov);
        document.getElementById('resumeYes').onclick = ()=>{ video.currentTime=Math.max(0,saved-2); plyr.play(); ov.remove(); };
        document.getElementById('resumeNo').onclick = ()=>{ clearTimeForCurrent(); plyr.play(); ov.remove(); };
      };

      if(video.readyState>=1) show(); else video.addEventListener('loadedmetadata', show, {once:true});
    }

    function playIndex(idx, {resumeIfSame=true, startTime=null}={}){
      if(idx<0 || idx>=playlist.length) return;
      current = idx; saveIndex();
      const {src, subs} = playlist[idx];
      tip.textContent = 'Loading…';

      // reset
      plyr.stop();
      video.removeAttribute('src');
      [...video.querySelectorAll('track')].forEach(t=>t.remove());
      video.load();

      if(subs){
        const track=document.createElement('track');
        track.kind='subtitles'; track.label='Subtitles'; track.srclang='en'; track.default=true; track.src=subs; video.appendChild(track);
      }

      const isHls = /\.m3u8($|\?)/i.test(src);
      const startAt = startTime!=null ? Math.max(0, startTime-2) : null;
      try{
        if(isHls && window.Hls && Hls.isSupported()){
          video.setAttribute('crossorigin','anonymous');
          if(window._hls){ window._hls.destroy(); }
          const hls = new Hls({ xhrSetup: (xhr)=>{ xhr.withCredentials = false; } });
          window._hls = hls;
          hls.loadSource(src);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, ()=>{ setQualityMenuFromHls(hls); tip.textContent='Playing via HLS'; if(startAt!==null){ video.currentTime = startAt; } handleResume(src, resumeIfSame); plyr.play(); });
          hls.on(Hls.Events.ERROR, (evt, data)=>{ if(data.fatal){ tip.textContent='HLS fatal error: '+data.type; }});
        } else if(isHls && video.canPlayType('application/vnd.apple.mpegurl')){
          video.setAttribute('crossorigin','anonymous');
          video.src = src; video.addEventListener('loadedmetadata', ()=>{ tip.textContent='Playing HLS (native)'; if(startAt!==null){ video.currentTime = startAt; } handleResume(src, resumeIfSame); plyr.play(); }, {once:true});
        } else {
          // MP4/WebM — avoid CORS mode
          video.removeAttribute('crossorigin');
          video.src = src; video.addEventListener('loadedmetadata', ()=>{ tip.textContent='Playing file'; if(startAt!==null){ video.currentTime = startAt; } handleResume(src, resumeIfSame); plyr.play(); }, {once:true});
        }
      }catch(e){ tip.textContent = 'Could not load media (possible CORS).'; }

      renderPlaylist();
    }

    function playNext(){ if(current+1 < playlist.length){ clearTimeForCurrent(); playIndex(current+1, {resumeIfSame:false}); } }

    // Persist current time every second (per-src)
    video.addEventListener('timeupdate', throttle(()=>{ if(!isNaN(video.currentTime) && playlist[current]) setTimeFor(playlist[current].src, Math.floor(video.currentTime)); }, 1000));
    window.addEventListener('beforeunload', ()=>{ if(!isNaN(video.currentTime) && playlist[current]) setTimeFor(playlist[current].src, Math.floor(video.currentTime)); });

    // Modal controls
    const modal = document.getElementById('modal');
    const addBtn = document.getElementById('addUrl');
    const m_url = document.getElementById('m_url');
    const m_poster = document.getElementById('m_poster');
    const m_subs = document.getElementById('m_subs');
    const m_cancel = document.getElementById('m_cancel');
    const m_add = document.getElementById('m_add');

    function openModal(){ modal.style.display='flex'; setTimeout(()=>m_url.focus(),0); }
    function closeModal(){ modal.style.display='none'; }

    addBtn.addEventListener('click', openModal);
    m_cancel.addEventListener('click', closeModal);
    m_add.addEventListener('click', ()=>{
      const url = m_url.value.trim(); if(!url) return;
      const poster = m_poster.value.trim();
      const subs = m_subs.value.trim();
      addToPlaylist({name: url.split('/').pop(), src: url, poster, subs});
      closeModal();
      m_url.value = m_poster.value = m_subs.value = '';
      if(current===-1) playIndex(0);
    });

    // ---------- Boot: restore previous session ----------
    async function init(){
      loadState();
      await loadDefaults();
      await loadSheet();
      renderPlaylist();
      if(playlist.length){
        if(current>=0 && current<playlist.length){
          const ep = playlist[current];
          const lastSrc = localStorage.getItem(LS_KEYS.lastsrc);
          const lastIdx = parseInt(localStorage.getItem(LS_KEYS.idx)||'-1',10);
          const saved = getTimeFor(ep.src);
          const sameItem = ep.src===lastSrc && current===lastIdx && saved>0;
          if(sameItem){
            const resume = confirm(`Resume from ${fmtTime(saved)}?`);
            if(resume){
              playIndex(current, {resumeIfSame:false, startTime:saved});
            } else {
              clearTimeForCurrent();
              playIndex(current, {resumeIfSame:false});
            }
          } else {
            playIndex(current, {resumeIfSame:true});
          }
        }
      }
    }
    init();
  </script>

<script>
// === Archive.org search integration (robust) ===
(function(){
  const VIDEO_EXT=/\.(mp4|webm|mkv|avi|m4v|mov|ts|m2ts|mts|3gp|3g2|mpe?g|mpg|wmv|m3u8)$/i;
  const fmtHMS=(sec)=>{sec=Math.floor(sec||0);const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;return h?`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${m}:${String(s).padStart(2,'0')}`};

  const ARCH_ADV='https://archive.org/advancedsearch.php';
  const ARCH_META=(id)=>`https://archive.org/metadata/${encodeURIComponent(id)}`;

  let searchInput, archBtn, archResults;
  function cacheEls(){
    searchInput=document.getElementById('searchBox');
    archBtn=document.getElementById('archSearchBtn');
    archResults=document.getElementById('archResults');
  }
  function ensureEls(){ if(!(searchInput&&archBtn&&archResults)) cacheEls(); return !!(searchInput&&archBtn&&archResults); }

  function renderArchResults(groups){
    if(!ensureEls()) return;
    archResults.innerHTML='';
    if(!groups.length){ archResults.textContent='No results.'; return; }
    const frag=document.createDocumentFragment();
    groups.forEach(g=>{
      if(!(g.files&&g.files.length)) return;
      const card=document.createElement('div');
      card.className='card';
      const filesHtml=(g.files||[]).map(f=>{
        const name=f.name||f.url.split('/').pop();
        const dur=(typeof f.lengthSec==='number'&&!isNaN(f.lengthSec))?fmtHMS(f.lengthSec):'';
        return `<div style="display:flex;justify-content:space-between;gap:8px;padding:8px;border-top:1px solid rgba(255,255,255,.06)">
          <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:65%">${name}</div>
          <div style="display:flex;gap:8px;align-items:center">
            ${dur?`<span class="pill" style="background:#1b2433;color:#cfe0ff">${dur}</span>`:''}
            <button class="btn ghost" data-url="${f.url}" data-title="${(g.title||g.identifier)}">Preview</button>
            <a class="btn" href="${f.url}" target="_blank" rel="noopener">Open</a>
          </div>
        </div>`;
      }).join('');
      card.innerHTML=`<div style="padding:12px 14px">
        <div style="font-weight:800">${g.title||g.identifier}</div>
        <a href="https://archive.org/details/${g.identifier}" target="_blank" rel="noopener" style="color:#93a4ba;font-size:12px">archive.org/details/${g.identifier}</a>
        <div style="color:#93a4ba;font-size:12px;margin-top:6px">${g.description||''}</div>
      </div>${filesHtml}`;
      frag.appendChild(card);
    });
    archResults.appendChild(frag);

    // hook preview buttons into existing playlist
    archResults.querySelectorAll('button[data-url]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const url=btn.getAttribute('data-url');
        const title=btn.getAttribute('data-title')||url.split('/').pop();
        try{
          addToPlaylist({name:`${title} • ${url.split('/').pop()}`, src:url});
          playIndex(playlist.length-1);
        }catch(err){ console.error('[PakStream] preview failed', err); }
      });
    });
  }

  async function fetchItemFiles(identifier){
    try{
      const r=await fetch(ARCH_META(identifier));
      if(!r.ok) return [];
      const data=await r.json();
      const d1 = (data.d1 || 'archive.org').replace(/^https?:\/\//,'').replace(/\/+$/,'');
      const dir = (data.dir || `/download/${identifier}`);
      const files=(data.files||[]).filter(f=>{
        const name=f.name||'';
        const fmt=(f.format||'').toLowerCase();
        const looksVideo=/video|mpeg-4|matroska|quicktime|wmv|ogg video|webm/.test(fmt);
        return VIDEO_EXT.test(name)||looksVideo;
      }).map(f=>({ name:f.name, url:`https://${d1}${dir}/${encodeURIComponent(f.name)}`, lengthSec:(f.length?Number(f.length):undefined) }));
      return files;
    }catch(e){
      console.error('[PakStream] fetchItemFiles error', e);
      return [];
    }
  }

  async function searchArchive(term){
    if(!ensureEls()) return;
    archResults.textContent='Searching…';
    try{
      const url=`${ARCH_ADV}?q=${encodeURIComponent(term)}&fl[]=identifier&fl[]=title&fl[]=description&output=json`;
      const r=await fetch(url);
      const data=await r.json();
      const docs=data && data.response && data.response.docs ? data.response.docs : [];
      const groups=[];
      for(const d of docs.slice(0,10)){
        const files=await fetchItemFiles(d.identifier);
        groups.push({identifier:d.identifier,title:d.title,description:d.description,files});
      }
      renderArchResults(groups);
    }catch(e){
      archResults.textContent='Search failed.';
      console.error('[PakStream] searchArchive error', e);
    }
  }

  function init(){
    if(!ensureEls()) return;
    archBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const t=(searchInput.value||'').trim();
      if(t) searchArchive(t);
    });
    searchInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        const t=(searchInput.value||'').trim();
        if(t) searchArchive(t);
      }
    });
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  }else{
    init();
  }
})();
</script>

<script>
(()=>{
  const TMDB_API_KEY = "YOUR_TMDB_API_KEY_HERE"; // TODO replace with real key
  const findInput = () => {
    let el = document.getElementById('searchBox');
    if (el) return el;
    el = document.querySelector('main input[type="search"], main input[type="text"], input[type="search"], input[type="text"]');
    if (el && !el.id) el.id = 'searchBox';
    return el;
  };

  const input = findInput();
  if (!input) return;

  let panel = document.getElementById('suggestions');
  if (!panel) {
    panel = document.createElement('div');
    panel.id = 'suggestions';
    input.insertAdjacentElement('afterend', panel);
  }

  let state = { items: [], index: -1, controller: null };

  function debounce(fn, delay){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), delay); };
  }

  function buildSuggestions(items){
    panel.innerHTML='';
    const frag=document.createDocumentFragment();
    items.forEach((txt,i)=>{
      const div=document.createElement('div');
      div.className='item';
      div.textContent=txt;
      div.addEventListener('mousedown',e=>{e.preventDefault();select(i);});
      frag.appendChild(div);
    });
    panel.appendChild(frag);
  }

  function triggerSearch(text){
    input.value=text;
    hide();
    if(typeof window.performSearch==='function'){
      window.performSearch(text);
    }else if(typeof window.onSearch==='function'){
      window.onSearch(text);
    }else if(input.form){
      input.form.submit();
    }else{
      input.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter',bubbles:true}));
    }
  }

  const position = ()=>{
    const r=input.getBoundingClientRect();
    panel.style.width=r.width+'px';
    panel.style.left=(r.left+window.scrollX)+'px';
    panel.style.top=(r.bottom+window.scrollY)+'px';
  };

  function show(){ if(!state.items.length) return; panel.style.display='block'; position(); }
  function hide(){ panel.style.display='none'; state.index=-1; state.items=[]; if(state.controller) state.controller.abort(); }

  async function fetchSuggest(q){
    if(state.controller) state.controller.abort();
    state.controller=new AbortController();
    try{
      const url=`https://api.themoviedb.org/3/search/multi?query=${encodeURIComponent(q)}&api_key=${TMDB_API_KEY}&include_adult=false`;
      const r=await fetch(url,{signal:state.controller.signal});
      if(!r.ok) throw new Error('bad');
      const data=await r.json();
      const items=(data.results||[]).filter(it=>it.media_type==='movie'||it.media_type==='tv').slice(0,8).map(it=>it.title||it.name);
      if(!items.length){ hide(); return; }
      state.items=items; buildSuggestions(items); show();
    }catch(err){ if(err.name!=='AbortError') hide(); }
  }

  const debouncedFetch=debounce(fetchSuggest,250);

  input.addEventListener('input',e=>{ const q=e.target.value.trim(); if(q) debouncedFetch(q); else hide(); });

  function highlight(){
    panel.querySelectorAll('.item').forEach((el,i)=>{ el.classList.toggle('active', i===state.index); });
  }

  function select(i){ const title=state.items[i]; if(title) triggerSearch(title); }

  input.addEventListener('keydown',e=>{
    if(panel.style.display==='none') return;
    if(e.key==='ArrowDown'){ e.preventDefault(); state.index=(state.index+1)%state.items.length; highlight(); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); state.index=(state.index-1+state.items.length)%state.items.length; highlight(); }
    else if(e.key==='Enter'){ if(state.index>-1){ e.preventDefault(); select(state.index); } }
    else if(e.key==='Escape'){ hide(); }
  });

  document.addEventListener('click',e=>{ if(e.target===input||panel.contains(e.target)) return; hide(); });
  window.addEventListener('resize',position);
  window.addEventListener('scroll',position,true);
})();
</script>

</body>
</html>
